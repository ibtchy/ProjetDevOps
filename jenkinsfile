pipeline {
environment {
            registry = "mahdihmida/projectachat"
            registryCredential = 'creddocker'
            dockerImage = ''
    }
  agent any
       stages {
        stage('Checkout GIT') {
            steps {
                echo 'Pulling'
                git branch: 'mahdi',
                credentialsId: 'cred',
                url: 'https://github.com/ibtchy/ProjetDevOps.git';
                
            }
        }
        stage('Maven Version'){
            steps {
                sh 'mvn -version'
            }
        }
        
        stage('compile'){
            steps {
                sh 'mvn compile -e'
            }
        }
        stage('package'){
            steps {
                sh 'mvn clean package -DskipTests'
            }
        } 
        stage ('test'){
        steps{
            sh 'mvn test -Dtest="tn.esprit.spring.FactureServiceImplTests.java"'
        }
        }
        stage("SonarQube"){
        steps {
                withSonarQubeEnv ( installationName: 'sonar'){
                sh 'mvn sonar:sonar'
                }
        }
        } 
        stage("Nexus") {
            steps {
                
                sh "mvn deploy -DskipTests "
            }
        }
        stage('Docker img build') {
                 steps {
                        script {
                            dockerImage = docker.build registry + ":$BUILD_NUMBER"
                        }
                    }
        }




         stage('Img Deploy') {
                  steps {
                        script {
                            docker.withRegistry( '', registryCredential ){

                            dockerImage.push()
                            }
                        }

                    }
                }

         stage('clean') {
                steps {
                        sh "docker rmi $registry:$BUILD_NUMBER"
                }
                }

        }
}
