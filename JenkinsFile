
pipeline {
 environment { 

        registry = "bouguerra03/oussamarepo" 

        registryCredential = 'dockerhub_id' 

        dockerImage = '' 

    }
    agent any

    stages {
        stage('Checkout GIT') {
            steps {
                echo 'Pulling'
               git branch: 'oussamabouguerra', credentialsId: 'cred', url: 'https://github.com/ibtchy/ProjetDevOps.git'
                
            }
        }
        stage('Maven Clean'){
            steps {
                sh 'mvn clean'
            }}
         stage('Maven Version'){
            steps {
                sh 'mvn -version'
            }
        }
        
        stage('Compile'){
            steps {
                sh 'mvn compile -e'
            }
        }
         
       stage('sonar')
       {
         steps{
         sh 'mvn sonar:sonar \
  -Dsonar.projectKey=ouss \
  -Dsonar.host.url=http://192.168.1.16:9000 \
  -Dsonar.login=b09bb14037a90ad1a004db60a00e66b4a7b8edab'
         }       
       }
           stage('JUNIT/MOCKITO')
       {
         steps{
         sh 'mvn test -Dtest="tn.esprit.spring.OperateurServiceTest.java"'
         }       
       }   
        stage('Nexus')
       {
         steps{
         sh 'mvn deploy -DskipTests'
         }       
       }    
        
       stage('Building our image') { 

            steps { 

                script { 

                    dockerImage = docker.build registry + ":$BUILD_NUMBER" 

                }

            } 

        }

        stage('Deploy our image') { 

            steps { 

                script { 

                    docker.withRegistry( '', registryCredential ) { 

                        dockerImage.push() 

                    }

                } 

            }

        } 

        stage('Cleaning up') { 

            steps { 

                sh "docker rmi $registry:$BUILD_NUMBER" 

            }

        }   
        
        stage('Docker Compose'){
        steps{
        sh'docker-compose up -d'
        }
        }
        
    }
}
