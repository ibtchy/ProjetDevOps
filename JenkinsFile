
pipeline {

    environment {
            registry = "salma2705/projetachat"
            registryCredential = 'dockerhubId'
            dockerImage = ''
    }
   agent any
    stages {
        stage('Checkout GIT') {
            steps {
                echo 'Pulling'
               git branch: 'salma', credentialsId: 'jenkinks_cred', url: 'https://github.com/ibtchy/ProjetDevOps.git'
            }
        }

         stage ('mvn Compile'){
            steps {
                 sh 'mvn compile -e'
            }
        }

        stage('package'){
                    steps {
                        sh 'mvn clean package -DskipTests'
                    }
        }

        stage ('Test MOCKITO'){
        steps{
            sh 'mvn test -Dtest="tn.esprit.spring.services.StockServiceImplTest.java"'
        }
        }


       stage("SonarQube"){
        steps {
                withSonarQubeEnv ( installationName: 'SonarQube'){
                sh 'mvn sonar:sonar'
                }
        }
        }


       stage ('Nexus'){
                steps{
                    sh 'mvn deploy -DskipTests'

                }
        }



        stage('Docker image build') {
                 steps {
                        script {
                            dockerImage = docker.build registry + ":latest"
                        }
                    }
        }




         stage('Image Deploy') {
                  steps {
                        script {
                            docker.withRegistry( '', registryCredential ) {
                            dockerImage.push()
                        }
                       }
                    }
                }

         stage('clean') {
                steps {
                        sh "docker rmi $registry:$BUILD_NUMBER"
                }
                }

           }
         }

    }
}
